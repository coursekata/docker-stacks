---
name: Build, Test, and Publish an Image

on:
  workflow_call:
    inputs:
      runs-on:
        description: The platform to run the action on
        type: string
        required: false
        default: ubuntu-latest
      publish:
        description: Whether to publish the image to remote registries
        type: boolean
        required: false
        default: false

jobs:
  base-r:
    uses: ./.github/workflows/build-test-publish.yml
    secrets: inherit
    with:
      runs-on: ${{ inputs.runs-on }}
      image: base-r-notebook
      labels: |
        org.opencontainers.image.title=Base R Notebook
        org.opencontainers.image.description=Jupyter Lab, Python, and R, and that's it.
      tags: |
        type=raw,value=python-3.11
        type=raw,value=r-4.3
      build-args: |
        PYTHON_VERSION=3.11
        R_VERSION=4.3
      publish: ${{ inputs.publish }}

  essentials:
    needs: [base-r]
    uses: ./.github/workflows/build-test-publish.yml
    secrets: inherit
    with:
      runs-on: ${{ inputs.runs-on }}
      image: essentials-notebook
      labels: |
        org.opencontainers.image.title=Essentials Notebook
        org.opencontainers.image.description=CourseKata essentials: everything used in the books.
      tags: |
        type=raw,value=python-3.11
        type=raw,value=r-4.3
      build-args: |
        BASE_IMAGE=${{ needs.base-r.outputs.image }}@${{ needs.base-r.outputs.digest}}
        PARENT_IMAGE=${{ needs.base-r.outputs.image }}
      publish: ${{ inputs.publish }}

  r:
    needs: [base-r, essentials]
    uses: ./.github/workflows/build-test-publish.yml
    secrets: inherit
    with:
      runs-on: ${{ inputs.runs-on }}
      image: r-notebook
      labels: |
        org.opencontainers.image.title=R Notebook
        org.opencontainers.image.description=CourseKata essentials and other R packages for teaching and learning data science.
      tags: |
        type=raw,value=python-3.11
        type=raw,value=r-4.3
      build-args: |
        BASE_IMAGE=${{ needs.base-r.outputs.image }}@${{ needs.base-r.outputs.digest}}
        PARENT_IMAGE=${{ needs.essentials.outputs.image }}@${{ needs.essentials.outputs.digest}}
      publish: ${{ inputs.publish }}

  datascience:
    needs: [base-r, r]
    uses: ./.github/workflows/build-test-publish.yml
    secrets: inherit
    with:
      runs-on: ${{ inputs.runs-on }}
      image: datascience-notebook
      labels: |
        org.opencontainers.image.title=Data Science Notebook
        org.opencontainers.image.description=R and Python packages for teaching and learning data science.
      tags: |
        type=raw,value=python-3.11
        type=raw,value=r-4.3
      build-args: |
        BASE_IMAGE=${{ needs.base-r.outputs.image }}@${{ needs.base-r.outputs.digest}}
        PARENT_IMAGE=${{ needs.r.outputs.image }}@${{ needs.r.outputs.digest}}
      publish: ${{ inputs.publish }}
