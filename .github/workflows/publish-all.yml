---
name: Build, Test, and Publish all Images

on:
  workflow_dispatch:
    inputs:
      runs-on:
        description: "The platform to build on"
        type: string
        required: false
        default: "ubuntu-latest"
  push:
    branches: [main]
    paths:
      - .github/actions/build-test-publish
      - .github/workflows/build-test-publish.yml
      - .github/workflows/publish-all.yml
      - base-r-notebook/**
      - essentials-notebook/**
      - r-notebook/**
      - datascience-notebook/**
  schedule:
    # Weekly, at 03:00 on Monday UTC time (see https://crontab.guru)
    - cron: "0 3 * * 1"

# https://docs.github.com/en/actions/using-jobs/using-concurrency
concurrency:
  # only cancel in-progress jobs or runs for the current workflow - matches against branch & tags
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  env:
    runs-on: ubuntu-latest
    steps:
      - name: Set output variables based on the inputs
        id: set-env
        run: |
          echo "runs-on=${{ github.event.inputs.runs-on || 'ubuntu-latest' }}" >> $GITHUB_OUTPUT
    outputs:
      runs-on: ${{ steps.set-env.outputs.runs-on }}
      python-version: "3.11"
      r-version: "4.3"
      tags: |
        type=raw,value=python-3.11
        type=raw,value=r-4.3

  publish:
    needs: [env]
    runs-on: ubuntu-latest
    steps:
      # https://github.com/jlumbroso/free-disk-space
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          dotnet: false
          haskell: false
          large-packages: false
          swap-storage: false

      # https://github.com/actions/checkout
      - name: Checkout
        uses: actions/checkout@v3

      # https://github.com/docker/setup-qemu-action
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # https://github.com/docker/setup-buildx-action
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # https://github.com/docker/login-action
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # https://github.com/docker/login-action
      - name: Login to Docker Registry
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: base-r-notebook
        uses: ./.github/actions/build-test-publish
        with:
          image: base-r-notebook
          labels: |
            org.opencontainers.image.title=Base R Notebook
            org.opencontainers.image.description=Jupyter Lab, Python, and R, and that's it.
          build-args: |
            PYTHON_VERSION=${{ needs.env.outputs.python-version }}
            R_VERSION=${{ needs.env.outputs.r-version }}
          tags: ${{ needs.env.outputs.tags }}

      - name: essentials-notebook
        uses: ./.github/actions/build-test-publish
        with:
          image: essentials-notebook
          labels: |
            org.opencontainers.image.title=Essentials Notebook
            org.opencontainers.image.description=CourseKata essentials: everything used in the books.
          tags: ${{ needs.env.outputs.tags }}

      - name: r-notebook
        uses: ./.github/actions/build-test-publish
        with:
          image: r-notebook
          labels: |
            org.opencontainers.image.title=R Notebook
            org.opencontainers.image.description=CourseKata essentials and other R packages for teaching and learning data science.
          tags: ${{ needs.env.outputs.tags }}

      - name: datascience-notebook
        uses: ./.github/actions/build-test-publish
        with:
          image: datascience-notebook
          labels: |
            org.opencontainers.image.title=Data Science Notebook
            org.opencontainers.image.description=R and Python packages for teaching and learning data science.
          tags: ${{ needs.env.outputs.tags }}
